<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LME Trade Request Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <script>
    const lmeHolidays = {
      2025: ["2025-01-01", "2025-03-18", "2025-04-21", "2025-05-05", "2025-05-26", "2025-08-25", "2025-12-25", "2025-12-26"],
      2026: ["2026-01-01", "2026-04-03", "2026-04-06", "2026-05-04", "2026-05-25", "2026-08-31", "2026-12-25"]
    };

    function formatDateEU(date) {
      const d = String(date.getDate()).padStart(2, '0');
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const y = String(date.getFullYear()).slice(-2);
      return `${d}-${m}-${y}`;
    }

    function getSecondBusinessDay(year, month) {
      const holidays = lmeHolidays[year] || [];
      let date = new Date(year, month + 1, 1);
      let count = 0;
      while (count < 2) {
        const isoDate = date.toISOString().split('T')[0];
        const day = date.getDay();
        if (day !== 0 && day !== 6 && !holidays.includes(isoDate)) count++;
        if (count < 2) date.setDate(date.getDate() + 1);
      }
      return formatDateEU(date);
    }

    function getFixPpt(dateFix, year) {
      const holidays = lmeHolidays[year] || [];
      let date = new Date(dateFix);
      let count = 0;
      while (count < 2) {
        date.setDate(date.getDate() + 1);
        const isoDate = date.toISOString().split('T')[0];
        const day = date.getDay();
        if (day !== 0 && day !== 6 && !holidays.includes(isoDate)) count++;
      }
      return formatDateEU(date);
    }

    function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

    function generateRequest(index) {
      try {
        const qtyInput = document.getElementById(`qty-${index}`);
        const q = parseFloat(qtyInput.value);
        const outputEl = document.getElementById(`output-${index}`);
        if (!isFinite(q)) {
          qtyInput.classList.add('border-red-500');
          if (outputEl) outputEl.textContent = 'Please enter a valid quantity.';
          qtyInput.focus();
          return;
        }
        qtyInput.classList.remove('border-red-500');
        const leg1Side = document.querySelector(`input[name='side1-${index}']:checked`).value;
        const leg1Type = document.getElementById(`type1-${index}`)?.value || 'AVG';
        const month = document.getElementById(`month1-${index}`).value;
        const year = parseInt(document.getElementById(`year1-${index}`).value);
        const leg2Side = document.querySelector(`input[name='side2-${index}']:checked`).value;
        const leg2Type = document.getElementById(`type2-${index}`).value;
        const dateFix = document.getElementById(`fixDate-${index}`).value;
        const useSamePPT = document.getElementById(`samePpt-${index}`).checked;
        const monthIndex = new Date(`${month} 1, ${year}`).getMonth();
        const pptDateAVG = getSecondBusinessDay(year, monthIndex);

        let leg1 = `${capitalize(leg1Side)} ${q} mt Al ${leg1Type === 'AVG' ? `AVG ${month} ${year} Flat` : `USD ppt ${pptDateAVG}`}`;
        let leg2;
        if (leg2Type === 'AVG') {
          const month2 = document.getElementById(`month2-${index}`).value;
          const year2 = parseInt(document.getElementById(`year2-${index}`).value);
          const ppt2 = getSecondBusinessDay(year2, new Date(`${month2} 1, ${year2}`).getMonth());
          leg2 = `${capitalize(leg2Side)} ${q} mt Al AVG ${month2} ${year2} Flat`;
        } else {
          const pptFix = useSamePPT ? pptDateAVG : getFixPpt(dateFix, year);
          leg2 = `${capitalize(leg2Side)} ${q} mt Al USD ppt ${pptFix}`;
        }

        const result = `LME Request: ${leg1} and ${leg2} against`;
        if (outputEl) outputEl.textContent = result;

        const finalOutput = document.getElementById('final-output');
        if (!finalOutput.value.includes(result)) finalOutput.value += result + "\n";
      } catch (e) {
        console.error("Error generating request:", e);
      }
    }

    function clearTrade(index) {
      const inputs = document.querySelectorAll(`#trade-${index} input, #trade-${index} select`);
      inputs.forEach(input => {
        if (input.type === 'radio') input.checked = input.defaultChecked;
        else if (input.type === 'checkbox') input.checked = false;
        else input.value = input.defaultValue;
      });
      document.getElementById(`output-${index}`).textContent = '';
      updateFinalOutput();
    }

    function removeTrade(index) {
      const trade = document.getElementById(`trade-${index}`);
      if (trade) {
        trade.remove();
        updateFinalOutput();
      }
    }

    function updateFinalOutput() {
      const allOutputs = document.querySelectorAll("[id^='output-']");
      const finalOutput = Array.from(allOutputs).map(el => el.textContent.trim()).filter(t => t).join("\n");
      document.getElementById('final-output').value = finalOutput;
    }

    function copyAll() {
      const text = document.getElementById('final-output').value;
      navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard'));
    }

    function addTrade() {
      const index = document.querySelectorAll('.trade-block').length;
      const template = document.getElementById('trade-template');
      const clone = template.content.cloneNode(true);
     clone.querySelectorAll('[id]').forEach(el => {
  const baseId = el.id.replace(/-\d+$/, '');
  el.id = `${baseId}-${index}`;
  if (el.name) el.name = el.name.replace(/-\d+$/, `-${index}`);
});
      clone.querySelector("[id^='output-']").id = `output-${index}`;
      clone.querySelector("button[name='generate']").setAttribute('onclick', `generateRequest(${index})`);
      clone.querySelector("button[name='clear']").setAttribute('onclick', `clearTrade(${index})`);
      clone.querySelector("button[name='remove']").setAttribute('onclick', `removeTrade(${index})`);
      const div = document.createElement('div');
      div.id = `trade-${index}`;
      div.className = 'trade-block';
      div.appendChild(clone);
      document.getElementById('trades').appendChild(div);
    }

    window.onload = () => addTrade();
  </script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">LME Trade Request Generator</h1>
    <div id="trades"></div>
    <button onclick="addTrade()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Add Trade</button>
    <button onclick="copyAll()" class="mt-4 ml-2 bg-green-600 text-white px-4 py-2 rounded">Copy All</button>
    <textarea id="final-output" class="mt-4 w-full h-40 border p-2" placeholder="All trade requests will appear here..."></textarea>
  </div>

  <template id="trade-template">
    <div class="bg-white p-4 rounded shadow mb-4">
      <label class="block font-semibold">Quantity (mt):</label>
      <input type="number" id="qty-0" class="border p-1 w-32 mb-2" min="0" step="0.01" />
      <div class="grid grid-cols-2 gap-4">
        <div>
          <h2 class="font-semibold">Leg 1</h2>
          <label><input type="radio" name="side1-0" value="buy" checked /> Buy</label>
          <label><input type="radio" name="side1-0" value="sell" /> Sell</label><br />
            <label class="block mt-2 mb-1 font-medium">Price Type: <span class="font-semibold text-gray-800">AVG</span></label>
            <input type="hidden" id="type1-0" value="AVG">
          </label>
          <label>Month:
            <select id="month1-0" class="border p-1">
              <option>January</option><option>February</option><option>March</option><option>April</option>
              <option>May</option><option>June</option><option>July</option><option>August</option>
              <option>September</option><option>October</option><option>November</option><option>December</option>
            </select>
          </label>
          <label>Year:
            <select id="year1-0" class="border p-1">
              <option>2025</option><option>2026</option>
            </select>
          </label>
        </div>
        <div>
          <h2 class="font-semibold">Leg 2</h2>
          <label><input type="radio" name="side2-0" value="buy" checked /> Buy</label>
          <label><input type="radio" name="side2-0" value="sell" /> Sell</label><br />
          <label>Price Type:
            <select id="type2-0" class="border p-1">
              <option value="AVG">AVG</option>
              <option value="Fix">Fix</option>
            </select>
          </label>
          <label>Month:
            <select id="month2-0" class="border p-1">
              <option>January</option><option>February</option><option>March</option><option>April</option>
              <option>May</option><option>June</option><option>July</option><option>August</option>
              <option>September</option><option>October</option><option>November</option><option>December</option>
            </select>
          </label>
          <label>Year:
            <select id="year2-0" class="border p-1">
              <option>2025</option><option>2026</option>
            </select>
          </label>
          <label>Fixing Date: <input type="date" id="fixDate-0" class="border p-1" /></label>
          <label><input type="checkbox" id="samePpt-0" /> Use AVG PPT Date</label>
        </div>
      </div>
      <div class="mt-3 space-x-2">
       <button name="generate" class="bg-blue-500 text-white px-4 py-1 rounded">Generate</button>
       <button name="clear" class="bg-yellow-500 text-white px-4 py-1 rounded">Clear</button>
       <button name="remove" class="bg-red-600 text-white px-4 py-1 rounded">Remove</button>
      </div>
      <p id="output-0" class="mt-2 font-mono text-sm"></p>
    </div>
  </template>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>
</body>
</html>
